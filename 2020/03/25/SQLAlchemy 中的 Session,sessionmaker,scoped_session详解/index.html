

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/logo.png">
  <link rel="icon" href="/img/logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="waymingz">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、关于 SQLAlchemy什么是SQLAlchemy？ 答：SQLAlchemy是一个关系型数据库框架，它提供了高层的 ORM 和底层的原生数据库的操作，让开发者不用直接和 SQL 语句打交道，而是通过 Python 对象来操作数据库，在舍弃一些性能开销的同时，换来的是开发效率的较大提升。 一句话：就是对数据库的抽象！  Session 其实 就是一个会话, 可以和数据库打交道的一个会话">
<meta property="og:type" content="article">
<meta property="og:title" content="SQLAlchemy 中的 Session,sessionmaker,scoped_session详解">
<meta property="og:url" content="https://waym1ng.github.io/2020/03/25/SQLAlchemy%20%E4%B8%AD%E7%9A%84%20Session,sessionmaker,scoped_session%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="MingMing&#39;blog">
<meta property="og:description" content="一、关于 SQLAlchemy什么是SQLAlchemy？ 答：SQLAlchemy是一个关系型数据库框架，它提供了高层的 ORM 和底层的原生数据库的操作，让开发者不用直接和 SQL 语句打交道，而是通过 Python 对象来操作数据库，在舍弃一些性能开销的同时，换来的是开发效率的较大提升。 一句话：就是对数据库的抽象！  Session 其实 就是一个会话, 可以和数据库打交道的一个会话">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-03-25T09:48:54.000Z">
<meta property="article:modified_time" content="2024-03-27T12:19:28.350Z">
<meta property="article:author" content="waymingz">
<meta property="article:tag" content="python 数据库 mysql sql">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>SQLAlchemy 中的 Session,sessionmaker,scoped_session详解 - MingMing&#39;blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"waym1ng.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"QaAc8EraW3qDuc3hldMvmw5p-gzGzoHsz","app_key":"oTgXIx2IwXcYJAPXLGPAdYJC","server_url":"https://qaac8era.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>明明的博客呀</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SQLAlchemy 中的 Session,sessionmaker,scoped_session详解"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2020-03-25 17:48" pubdate>
          2020年3月25日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          113 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">SQLAlchemy 中的 Session,sessionmaker,scoped_session详解</h1>
            
            
              <div class="markdown-body">
                
                <span id="more"></span>

<h2 id="一、关于-SQLAlchemy"><a href="#一、关于-SQLAlchemy" class="headerlink" title="一、关于 SQLAlchemy"></a>一、关于 SQLAlchemy</h2><p>什么是SQLAlchemy？</p>
<p>答：SQLAlchemy是一个关系型数据库框架，它提供了高层的 ORM 和底层的原生数据库的操作，让开发者不用直接和 SQL 语句打交道，而是通过 Python 对象来操作数据库，在舍弃一些性能开销的同时，换来的是开发效率的较大提升。</p>
<p>一句话：就是对数据库的抽象！</p>
<hr>
<p>Session 其实 就是一个会话, 可以和数据库打交道的一个会话</p>
<p>在一般的意义上， 会话建立与数据库的所有对话，并为你在其生命周期中加载或关联的所有对象表示一个“等待区”。他提供了一个入口点获得查询对象， 向数据库发送查询，使用会话对象的当前数据库连接， 将结果行填充在对象中， 然后存储在会话中， 在这种结构中称为身份映射 – 这种数据结构维护了每一个副本的唯一， 这种唯一意味着一个对象只能有一个特殊的唯一主键。</p>
<p>会话以基本无状态的形式开始，一旦发出查询或其他对象被持久化，它就会从一个引擎申请连接资源，该引擎要么与会话本身相关联，要么与正在操作的映射对象相关联。此连接标识正在进行的事务， 在会话提交或回滚其挂起状态之前，该事务一直有效。</p>
<p>会话中维护的所有变化的对象都会被跟踪 - 在再次查询数据库或提交当前事务之前， 它将刷新对数据库的所有更改， 这被称为工作模式单元。</p>
<p>在使用会话时候，最重要的是要注意与它相关联的对象是会话所持有的事务的代理对象 - 为了保持同步，有各种各样的事件会导致对象重新访问数据库。可能从会话中分离对象并继续使用他们，尽管这种做法有其局限性。但是通常来说，当你希望再次使用分离的对象时候，你会将他们与另一个会话重新关联起来， 以便他们能够恢复表示数据库状态的正常任务</p>
<h3 id="1-Session是缓存吗？"><a href="#1-Session是缓存吗？" class="headerlink" title="1. Session是缓存吗？"></a>1. Session是缓存吗？</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">可能会将这里的session与http中的session搞混，需要注意的是，它有点用作缓存，因为它实现了 身份映射 模式，并存储了键入其主键的对象。但是，它不执行任何类型的查询缓存。<br>此外，默认情况下，Session使用弱引用存储对象实例。这也违背了将Session用作缓存的目的。关于session强应用下次再讨论。<br></code></pre></td></tr></table></figure>

<h3 id="2-Session作用："><a href="#2-Session作用：" class="headerlink" title="2. Session作用："></a>2. Session作用：</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1.</span> <span class="hljs-keyword">session</span>创建和管理数据库连接的会话<br><span class="hljs-number">2.</span> model <span class="hljs-keyword">object</span> 通过<span class="hljs-keyword">session</span>对象访问数据库，并把访问到的数据以 <span class="hljs-keyword">Identity</span> Map的方式，映射到Model <span class="hljs-keyword">object</span>中<br></code></pre></td></tr></table></figure>

<h3 id="3-Session生命周期："><a href="#3-Session生命周期：" class="headerlink" title="3. Session生命周期："></a>3. Session生命周期：</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1.</span> <span class="hljs-keyword">session</span>在刚被创建的时候，还没有和任何model <span class="hljs-keyword">object</span> 绑定，可认为是无状态的<br><span class="hljs-number">2.</span> <span class="hljs-keyword">session</span> 接受到query查询语句, 执行的结果或保持或者关联到<span class="hljs-keyword">session</span>中<br><span class="hljs-number">3.</span> 任意数量的model <span class="hljs-keyword">object</span>被创建，并绑定到<span class="hljs-keyword">session</span>中，<span class="hljs-keyword">session</span>会管理这些对象<br><span class="hljs-number">4.</span> 一旦<span class="hljs-keyword">session</span> 里面的objects 有变化，那可是要<span class="hljs-keyword">commit</span>/<span class="hljs-keyword">rollback</span>提交或者放弃changs<br></code></pre></td></tr></table></figure>

<h3 id="4-Session什么时候创建，提交，关闭？"><a href="#4-Session什么时候创建，提交，关闭？" class="headerlink" title="4. Session什么时候创建，提交，关闭？"></a>4. Session什么时候创建，提交，关闭？</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">一般来说，<span class="hljs-keyword">session</span>在需要访问数据库的时候创建，在<span class="hljs-keyword">session</span>访问数据库的时候，准确来说，应该是“<span class="hljs-keyword">add</span>/<span class="hljs-keyword">update</span>/<span class="hljs-keyword">delete</span>”数据库的时候，会开启<span class="hljs-keyword">database</span> <span class="hljs-keyword">transaction</span>。<br><br>假设没有修改autocommit的默认值(<span class="hljs-keyword">False</span>), 那么，<span class="hljs-keyword">database</span> <span class="hljs-keyword">transaction</span> 一直会保持，只有等到<span class="hljs-keyword">session</span>发生rolled back、<span class="hljs-keyword">committed</span>、或者closed的时候才结束，一般建议，当<span class="hljs-keyword">database</span> <span class="hljs-keyword">transaction</span>结束的时候，同时<span class="hljs-keyword">close</span> <span class="hljs-keyword">session</span>,以保证，每次发起请求，都会创建一个新的<span class="hljs-keyword">session</span><br><br>特别是对web应用来说，发起一个请求，若请求使用到<span class="hljs-keyword">Session</span>访问数据库，则创建<span class="hljs-keyword">session</span>，处理完这个请求后，关闭<span class="hljs-keyword">session</span><br></code></pre></td></tr></table></figure>

<h3 id="4-获取一个Session："><a href="#4-获取一个Session：" class="headerlink" title="4. 获取一个Session："></a>4. 获取一个Session：</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">Session</span> 是一个直接实例化的常规的Python 类。然而， 为了标准会会话的配置和获取方式， sessionmaker 类通常用于创建顶级会话配置， 然后可以在整个应用程序中使用它， 就不需要重复配置参数。<br></code></pre></td></tr></table></figure>

<p>下面是sessionmaker 的使用方式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine<br><span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> sessionmaker<br><br><span class="hljs-comment"># 创建连接数据库的引擎，session连接数据库需要</span><br>my_engine = create_engine(<span class="hljs-string">&#x27;mysql+pymysql://root:123456@localhost/my_db&#x27;</span>)<br><br><span class="hljs-comment"># 创建一个配置过的Session类</span><br>Session = sessionmaker(bind=my_engine)<br><br><span class="hljs-comment"># 实例化一个session</span><br>db_session = Session()<br><br><span class="hljs-comment"># 使用session</span><br>myobject = MyObject(<span class="hljs-string">&#x27;foo&#x27;</span>, <span class="hljs-string">&#x27;bar&#x27;</span>)<br>db_session.add(myobject)<br>db_session.commit()<br><br></code></pre></td></tr></table></figure>

<p>在上面，该**sessionmaker()创建了一个工厂类，在创建这个工厂类时我们配置了参数绑定了引擎。将其赋值给Session。每次实例化Session都会创建一个绑定了引擎的Session。**这样这个session在访问数据库时都会通过这个绑定好的引擎来获取连接资源<br>当你编写应用程序时， 请将sessionmaker 工厂放在全局级别，视作应用程序配置的一部分。例如：应用程序包中有三个.py文件，您可以将该sessionmaker行放在__init__.py文件中; 在其他模块“from mypackage import Session”。这样，所有的Session()的配置都由该配置中心控制。</p>
<h3 id="5-关于SQLAlchemy-的-create-engine："><a href="#5-关于SQLAlchemy-的-create-engine：" class="headerlink" title="5. 关于SQLAlchemy 的 create_engine："></a>5. 关于SQLAlchemy 的 create_engine：</h3><p>直接只用 create_engine 时，就会创建一个带连接池的引擎：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">my_engine = create<span class="hljs-constructor">_engine(&#x27;<span class="hljs-params">mysql</span>+<span class="hljs-params">pymysql</span>:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-params">root</span>:123456@<span class="hljs-params">localhost</span><span class="hljs-operator">/</span><span class="hljs-params">my_db</span>&#x27;)</span><br></code></pre></td></tr></table></figure>

<p>创建一个session，连接池会分配一个connection。当session在使用后显示地调用 session.close()，也不能把这个连接关闭，而是由由QueuePool连接池管理并复用连接。</p>
<p>确保 session 在使用完成后用 session.close、session.commit 或 session.rollback 把连接还回 pool，这是一个必须在意的习惯。</p>
<p><strong>关于SQLAlchemy 数据库连接池：</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">session</span> 和 <span class="hljs-keyword">connection</span> 不是相同的东西， <span class="hljs-keyword">session</span> 使用连接来操作数据库，一旦任务完成 <span class="hljs-keyword">session</span> 会将数据库 <span class="hljs-keyword">connection</span> 交还给 pool。<br><br>在使用 create_engine 创建引擎时，如果默认不指定连接池设置的话，一般情况下，SQLAlchemy 会使用一个 QueuePool 绑定在新创建的引擎上。并附上合适的连接池参数<br></code></pre></td></tr></table></figure>

<p>create_engine() 函数和连接池相关的参数有：</p>
<ul>
<li>pool_recycle, 默认为 -1, 推荐设置为 7200, 即如果 connection 空闲了 7200 秒，自动重新获取，以防止 connection 被 db server 关闭。</li>
<li>pool_size&#x3D;5, 连接数大小，默认为 5，正式环境该数值太小，需根据实际情况调大</li>
<li>max_overflow&#x3D;10, 超出 pool_size 后可允许的最大连接数，默认为 10, 这 10 个连接在使用过后，不放在 pool 中，而是被真正关闭的。</li>
<li>pool_timeout&#x3D;30, 获取连接的超时阈值，默认为 30 秒</li>
</ul>
<p>SQLAlchemy不使用连接池：<br>在创建引擎时指定参数 poolclass&#x3D;NullPool 即禁用了SQLAlchemy提供的数据库连接池。SQLAlchemy 就会在执行 session.close() 后立刻断开数据库连接。当然，如果没有被调用 session.close()，则数据库连接不会被断开，直到程序终止。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">my_engine = create<span class="hljs-constructor">_engine(&#x27;<span class="hljs-params">mysql</span>+<span class="hljs-params">pymysql</span>:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-params">root</span>:123456@<span class="hljs-params">localhost</span><span class="hljs-operator">/</span><span class="hljs-params">my_db</span>&#x27;，<span class="hljs-params">poolclass</span>=NullPool)</span><br></code></pre></td></tr></table></figure>

<p>关于 SQLAlchemy 的 engine ,这里有一篇文章写的很好：<a target="_blank" rel="noopener" href="http://sunnyingit.github.io/book/section_python/SQLalchemy-engine.html">http://sunnyingit.github.io/book/section_python/SQLalchemy-engine.html</a></p>
<h3 id="6-关于线程安全："><a href="#6-关于线程安全：" class="headerlink" title="6. 关于线程安全："></a>6. 关于线程安全：</h3><p>session不是线程安全的，在多线程的环境中，默认情况下，多个线程将会共享同一个session。试想一下，假设A线程正在使用session处理数据库，B线程已经执行完成，把session给close了，那么此时A在使用session就会报错，怎么避免这个问题？</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1.</span> 可以考虑在这些线程之间共享<span class="hljs-keyword">Session</span>及其对象。但是应用程序需要确保实现正确的锁定方案，以便多个线程不会同时访问<span class="hljs-keyword">Session</span>或其状态。SQLAlchemy 中的 scoped_session 就可以证线程安全，下面会有讨论。<br><span class="hljs-number">2.</span> 为每个并发线程维护一个会话，而不是将对象从一个<span class="hljs-keyword">Session</span>复制到另一个<span class="hljs-keyword">Session</span>，通常使用<span class="hljs-keyword">Session</span>.merge()方法将对象的状态复制到一个不同<span class="hljs-keyword">Session</span>的新的本地对象中。<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="二、单线程下-scoped-session-对创建-Session-的影响"><a href="#二、单线程下-scoped-session-对创建-Session-的影响" class="headerlink" title="二、单线程下 scoped_session 对创建 Session 的影响"></a>二、单线程下 scoped_session 对创建 Session 的影响</h2><p>上面简单介绍了sessionmaker的作用，下面开始探讨 scoped_session 对创建 Session 的影响。现在先探讨单线程情况。</p>
<hr>
<p>先声明待会实验用的模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sqlalchemy.ext.declarative <span class="hljs-keyword">import</span> declarative_base<br><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> Column, Integer, String<br><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine<br><br><br>Base = declarative_base<br>engine = create_engine(<span class="hljs-string">&quot;mysql+pymysql://root:123456@127.0.0.1:3306/my_db?charset=utf8mb4&quot;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-title class_ inherited__">Base</span>):<br>    __tablename__ = <span class="hljs-string">&#x27;Person&#x27;</span><br><br>    <span class="hljs-built_in">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>, autoincrement=<span class="hljs-literal">True</span>)<br>    name = Column(String(length=<span class="hljs-number">64</span>), comment=<span class="hljs-string">&#x27;姓名&#x27;</span>)<br>    mobile = Column(String(length=<span class="hljs-number">13</span>), comment=<span class="hljs-string">&#x27;手机号&#x27;</span>)<br>    id_card_number = Column(String(length=<span class="hljs-number">64</span>), comment=<span class="hljs-string">&#x27;身份证&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;%s(name=%r,mobile=%r,id_card_number=%r)&#x27;</span> % (<br>            self.__class__.__name__,<br>            self.name,<br>            self.mobile,<br>            self.id_card_number<br>        )<br><br><span class="hljs-comment"># 在数据库中创建模型对象的表</span><br>Base.metadata.create_all(engine)<br><br></code></pre></td></tr></table></figure>

<h3 id="1-两个-Session-添加同一个对象"><a href="#1-两个-Session-添加同一个对象" class="headerlink" title="1. 两个 Session 添加同一个对象"></a>1. 两个 Session 添加同一个对象</h3><p>1.1 在 commit 之前添加：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> sessionmaker, scoped_session<br><br><br>session_factory = sessionmaker(bind=engine)<br><span class="hljs-comment"># engine 在上面已经创建好了</span><br><br><br>person = Person(name=<span class="hljs-string">&#x27;frank-&#x27;</span> + <span class="hljs-string">&#x27;job3&#x27;</span>, mobile=<span class="hljs-string">&#x27;111111&#x27;</span>, id_card_number=<span class="hljs-string">&#x27;123456789&#x27;</span>)<br><br>Session= session_factory()<br>s1= session_factory()<br><span class="hljs-comment"># s1 : &lt;sqlalchemy.orm.session.Session object at 0x107ec8c18&gt;</span><br><br>s2 = session_factory() <br><span class="hljs-comment"># s2 : &lt;sqlalchemy.orm.session.Session object at 0x107ee3ac8&gt;</span><br><br><span class="hljs-built_in">print</span>(s1 <span class="hljs-keyword">is</span> s2)<br><span class="hljs-comment"># False</span><br><br><span class="hljs-built_in">id</span>(s1),<span class="hljs-built_in">id</span>(s2)<br><span class="hljs-comment"># 4427910168, 4428020424</span><br><br>s1.add(person)<br>s2.add(person)<br><span class="hljs-comment"># 会报错！</span><br><span class="hljs-comment"># sqlalchemy.exc.InvalidRequestError: Object &#x27;&lt;Person at 0x22beb14bf60&gt;&#x27; is already attached to session &#x27;2&#x27; (this is &#x27;3&#x27;)</span><br><br></code></pre></td></tr></table></figure>

<p><strong>结论：</strong></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs armasm">通过 sessionmaker 工厂创建了两个 Session ，而且可以看到 <span class="hljs-built_in">s1</span> <span class="hljs-built_in">s2</span> 是两个不同的 Session 。<br>在 <span class="hljs-built_in">s1</span> 添加 person 后，继续使用 <span class="hljs-built_in">s2</span> 添加 person 报错. 说 person 这个对象 已经和 另一个 Session 关联一起来了, 所以再次关联另一个 Session 就会报错。<br></code></pre></td></tr></table></figure>

<p>1.2 在 commit 之后添加：</p>
<p>即在上面代码的 s1.add(person) 之后， s1.commit() ,然后再 s2.add(persion)<br>这里就没帖代码了。</p>
<p><strong>结论：</strong></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs armasm">即使在 <span class="hljs-built_in">s1</span> 提交之后，<span class="hljs-built_in">s2</span> 再去添加 person 也会发生错误,但 <span class="hljs-built_in">s1</span> 的提交是成功了的，数据 person 已经存放在数据库了。<br>当 <span class="hljs-built_in">s1</span> 添加 person 并提交，然后关闭 <span class="hljs-built_in">s1</span> ,<span class="hljs-built_in">s2</span>再去添加并提交 person 数据库,这不会报错，但是数据库也不会出现两条 person 数据。<br></code></pre></td></tr></table></figure>

<p>1.3 再 close 之后添加：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">p = Person(name=<span class="hljs-string">&#x27;frank&#x27;</span>, mobile=<span class="hljs-string">&#x27;11111111&#x27;</span>, id_card_number=<span class="hljs-string">&#x27;123456789&#x27;</span>)<br><br>s1.add(p)<br>s1.commit()<br><br>s2.add(p)<br>s2.commit()<br><br><span class="hljs-comment"># 也会报错！！！</span><br><span class="hljs-comment"># sqlalchemy.exc.InvalidRequestError: Object &#x27;&lt;Person at 0x21207e3e128&gt;&#x27; is already attached to session &#x27;2&#x27; (this is &#x27;3&#x27;)</span><br><br><br>p = Person(name=<span class="hljs-string">&#x27;frankcc&#x27;</span>, mobile=<span class="hljs-string">&#x27;1111111122&#x27;</span>, id_card_number=<span class="hljs-string">&#x27;1234567890&#x27;</span>)<br><br>s1.add(p)<br>s1.commit()<br>s1.close()<br>s2.add(p)<br>s2.commit()<br><br><span class="hljs-comment"># 不会报错</span><br><br></code></pre></td></tr></table></figure>

<p><strong>结论：</strong></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-built_in">s1</span> 关闭之后， <span class="hljs-built_in">s2</span>再去添加提交同一个对象，不会报错，但是数据库值有一条 person 数据。<br></code></pre></td></tr></table></figure>

<h3 id="2-不同的-Session-添加不同的对象"><a href="#2-不同的-Session-添加不同的对象" class="headerlink" title="2. 不同的 Session 添加不同的对象"></a>2. 不同的 Session 添加不同的对象</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">person4 = Person(name=<span class="hljs-string">&#x27;frank-&#x27;</span> + <span class="hljs-string">&#x27;job4&#x27;</span>, mobile=<span class="hljs-string">&#x27;4444444444&#x27;</span>, id_card_number=<span class="hljs-string">&#x27;123456789&#x27;</span>)<br>person1 = Person(name=<span class="hljs-string">&#x27;frank-&#x27;</span> + <span class="hljs-string">&#x27;job1&#x27;</span>, mobile=<span class="hljs-string">&#x27;111111&#x27;</span>, id_card_number=<span class="hljs-string">&#x27;123456789&#x27;</span>)<br><br>s1.add(person1)<br>s2.add(person4)<br>s1.commit()  <span class="hljs-comment"># 提交数据</span><br>s2.commit()  <span class="hljs-comment"># 提交数据, 写入数据库</span><br><br></code></pre></td></tr></table></figure>

<p><strong>结论：</strong></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm">当然，<span class="hljs-built_in">s1</span> ,<span class="hljs-built_in">s2</span> 添加提交不同的对象，不会出错。在数据库成功新增数据。 <br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br>mysql&gt; select * from person;<br>+----+------------+------------+----------------+<br>| <span class="hljs-built_in">id</span> | name       | mobile     | id_card_number |<br>+----+------------+------------+----------------+<br>|  1 | frank-job1 | 111111     | 123456789      |<br>|  2 | frank-job4 | 4444444444 | 123456789      |<br>+----+------------+------------+----------------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br></code></pre></td></tr></table></figure>

<hr>
<p><strong>以上说明：</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">一个对象一旦被一个 <span class="hljs-keyword">Session</span> 添加，除非关闭这个 <span class="hljs-keyword">Session</span> ，不然其他的 <span class="hljs-keyword">Session</span> 无法添加这个对象。<br>一个 <span class="hljs-keyword">Session</span> 添加并提交一个对象，然后关闭该 <span class="hljs-keyword">Session</span> ，其他的 <span class="hljs-keyword">Session</span> 可以添加并提交这个对象，但是数据库并不会有这条数据。<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-用-scoped-session-创建-Session"><a href="#3-用-scoped-session-创建-Session" class="headerlink" title="3. 用 scoped_session 创建 Session"></a>3. 用 scoped_session 创建 Session</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>session_factory = sessionmaker(bind=engine)<br>Session = scoped_session(session_factory)<br><br><br>s1 = Session()<br><span class="hljs-comment"># &lt;sqlalchemy.orm.session.Session object at 0x0000020E58690240&gt;</span><br><br>s2 = Session()<br><span class="hljs-comment"># &lt;sqlalchemy.orm.session.Session object at 0x0000020E58690240&gt;</span><br><br><span class="hljs-built_in">print</span>(s1 <span class="hljs-keyword">is</span> s2)<br><span class="hljs-comment"># True</span><br><br><br>p = Person(name=<span class="hljs-string">&#x27;frankaaabb&#x27;</span>, mobile=<span class="hljs-string">&#x27;1111111122233&#x27;</span>, id_card_number=<span class="hljs-string">&#x27;12345678900099&#x27;</span>)<br><br>s1.add(p)<br>s2.add(p)<br>s2.commit()<br><br></code></pre></td></tr></table></figure>

<p><strong>结论：</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">可以看到，通过scoped_session再去创建 <span class="hljs-keyword">Session</span> ，返回的是同一个 <span class="hljs-keyword">Session</span> 。<br>scoped_session类似单例模式，当我们调用使用的时候，会先在Registry里找找之前是否已经创建<span class="hljs-keyword">Session</span>，未创建则创建 <span class="hljs-keyword">Session</span> ，已创建则直接返回。<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="三、多线程下-scoped-session-对创建-Session-的影响"><a href="#三、多线程下-scoped-session-对创建-Session-的影响" class="headerlink" title="三、多线程下 scoped_session 对创建 Session 的影响"></a>三、多线程下 scoped_session 对创建 Session 的影响</h2><p>这里探讨在多线程下使用 scoped_session 与不使用 scoped_session 的情况</p>
<hr>
<h3 id="1-当不用-scoped-session-时："><a href="#1-当不用-scoped-session-时：" class="headerlink" title="1. 当不用 scoped_session 时："></a>1. 当不用 scoped_session 时：</h3><p>当不使用 scoped_session 时，也分两种情况，是否创建全局性 Session</p>
<p>1.1 多线程下不设置 Session 为全局变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>session_factory = sessionmaker(bind=engine)<br>Session = session_factory<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">job</span>(<span class="hljs-params">name</span>):<br>    session = Session()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;id session:<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>(session)&#125;</span>&quot;</span>)<br><br>    person = Person(name=<span class="hljs-string">&#x27;frank-&#x27;</span> + name, mobile=<span class="hljs-string">&#x27;111111&#x27;</span>, id_card_number=<span class="hljs-string">&#x27;123456789&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;name&#125;</span> person is add..&quot;</span>)<br>    session.add(person)<br><br>    time.sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> name == <span class="hljs-string">&#x27;job3&#x27;</span>:<br>        <span class="hljs-comment"># 线程3 提交, 其他线程不提交.</span><br>        session.commit()<br>        session.close()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>    thread_list = []<br><br>    <span class="hljs-comment"># 创建5个线程</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        name = <span class="hljs-string">&#x27;job&#x27;</span> + <span class="hljs-built_in">str</span>(i)<br>        t = threading.Thread(target=job, name=name, args=(name,))<br><br>        thread_list.append(t)<br><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> thread_list:<br>        t.start()<br><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> thread_list:<br>        t.join()<br><br></code></pre></td></tr></table></figure>

<p><strong>结论：</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">每个线程下的 <span class="hljs-keyword">Session</span> 都是不同的 <span class="hljs-keyword">Session</span><br>数据库成功新增了线程<span class="hljs-number">3</span>提交的数据，其他的线程中的数据并没有提交到数据库中去。<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br><span class="hljs-built_in">id</span> session:2557871997392<br>job0 person is add..<br><span class="hljs-built_in">id</span> session:2557871998064<br>job1 person is add..<br><span class="hljs-built_in">id</span> session:2557871998568<br>job2 person is add..<br><span class="hljs-built_in">id</span> session:2557871999072<br>job3 person is add..<br><span class="hljs-built_in">id</span> session:2557871999688<br>job4 person is add..<br><br><br>mysql&gt; select * from person;<br>+----+------------+--------+----------------+<br>| <span class="hljs-built_in">id</span> | name       | mobile | id_card_number |<br>+----+------------+--------+----------------+<br>| 14 | frank-job3 | 111111 | 123456789      |<br>+----+------------+--------+----------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br></code></pre></td></tr></table></figure>

<p>1.2 在多线程下用全局 Session</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>session_factory = sessionmaker(bind=engine)<br>Session = session_factory<br>session = Session()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">job</span>(<span class="hljs-params">name</span>):<br>    <span class="hljs-keyword">global</span> session<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;id session:<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>(session)&#125;</span>&quot;</span>)<br><br>    person = Person(name=<span class="hljs-string">&#x27;frank-&#x27;</span> + name, mobile=<span class="hljs-string">&#x27;111111&#x27;</span>, id_card_number=<span class="hljs-string">&#x27;123456789&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;name&#125;</span> person is add..&quot;</span>)<br>    session.add(person)<br><br>    time.sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> name == <span class="hljs-string">&#x27;job3&#x27;</span>:<br>        <span class="hljs-comment"># 线程3 提交, 其他线程不提交.</span><br>        session.commit()<br>        session.close()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>    thread_list = []<br><br>    <span class="hljs-comment"># 创建5个线程</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        name = <span class="hljs-string">&#x27;job&#x27;</span> + <span class="hljs-built_in">str</span>(i)<br>        t = threading.Thread(target=job, name=name, args=(name,))<br><br>        thread_list.append(t)<br><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> thread_list:<br>        t.start()<br><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> thread_list:<br>        t.join()<br><br></code></pre></td></tr></table></figure>

<p><strong>结论：</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">全部线程下的 <span class="hljs-keyword">Session</span> 都时同一个 <span class="hljs-keyword">Session</span><br>每个线程下的数据都被提交到了数据库<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br><span class="hljs-built_in">id</span> session:2737857674824<br>job0 person is add..<br><span class="hljs-built_in">id</span> session:2737857674824<br>job1 person is add..<br><span class="hljs-built_in">id</span> session:2737857674824<br>job2 person is add..<br><span class="hljs-built_in">id</span> session:2737857674824<br>job3 person is add..<br><span class="hljs-built_in">id</span> session:2737857674824<br>job4 person is add..<br><br><br>mysql&gt; select * from person;<br>+----+------------+--------+----------------+<br>| <span class="hljs-built_in">id</span> | name       | mobile | id_card_number |<br>+----+------------+--------+----------------+<br>| 15 | frank-job0 | 111111 | 123456789      |<br>| 16 | frank-job2 | 111111 | 123456789      |<br>| 17 | frank-job1 | 111111 | 123456789      |<br>| 18 | frank-job3 | 111111 | 123456789      |<br>| 19 | frank-job4 | 111111 | 123456789      |<br>+----+------------+--------+----------------+<br>5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br></code></pre></td></tr></table></figure>

<h3 id="2-当使用-scoped-session-时："><a href="#2-当使用-scoped-session-时：" class="headerlink" title="2. 当使用 scoped_session 时："></a>2. 当使用 scoped_session 时：</h3><p>2.1 多线程下不设置 Session 为全局变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>session_factory = sessionmaker(bind=engine)<br>Session = scoped_session(session_factory)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">job</span>(<span class="hljs-params">name</span>):<br>    session = Session()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;id session:<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>(session)&#125;</span>&quot;</span>)<br><br>    person = Person(name=<span class="hljs-string">&#x27;frank-&#x27;</span> + name, mobile=<span class="hljs-string">&#x27;111111&#x27;</span>, id_card_number=<span class="hljs-string">&#x27;123456789&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;name&#125;</span> person is add..&quot;</span>)<br>    session.add(person)<br><br>    time.sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> name == <span class="hljs-string">&#x27;job3&#x27;</span>:<br>        <span class="hljs-comment"># 线程3 提交, 其他线程不提交.</span><br>        session.commit()<br>        session.close()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>    thread_list = []<br><br>    <span class="hljs-comment"># 创建5个线程</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        name = <span class="hljs-string">&#x27;job&#x27;</span> + <span class="hljs-built_in">str</span>(i)<br>        t = threading.Thread(target=job, name=name, args=(name,))<br><br>        thread_list.append(t)<br><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> thread_list:<br>        t.start()<br><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> thread_list:<br>        t.join()<br><br><br></code></pre></td></tr></table></figure>

<p><strong>结论：</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">每个线程下的 <span class="hljs-keyword">Session</span> 都不相同<br>只有线程<span class="hljs-number">3</span>下的数据被提交到了数据库<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br><span class="hljs-built_in">id</span> session:2173841850832<br>job0 person is add..<br><span class="hljs-built_in">id</span> session:2173841851504<br>job1 person is add..<br><span class="hljs-built_in">id</span> session:2173841851896<br>job2 person is add..<br><span class="hljs-built_in">id</span> session:2173841852008<br>job3 person is add..<br><span class="hljs-built_in">id</span> session:2173841853128<br>job4 person is add..<br><br><br>mysql&gt; select * from person;<br>+----+------------+--------+----------------+<br>| <span class="hljs-built_in">id</span> | name       | mobile | id_card_number |<br>+----+------------+--------+----------------+<br>| 32 | frank-job3 | 111111 | 123456789      |<br>+----+------------+--------+----------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><br></code></pre></td></tr></table></figure>

<p>2.2 多线程下设置 Session 为全局变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>session_factory = sessionmaker(bind=engine)<br>Session = scoped_session(session_factory)<br>session = Session()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">job</span>(<span class="hljs-params">name</span>):<br>    <span class="hljs-keyword">global</span> session<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;id session:<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>(session)&#125;</span>&quot;</span>)<br><br>    person = Person(name=<span class="hljs-string">&#x27;frank-&#x27;</span> + name, mobile=<span class="hljs-string">&#x27;111111&#x27;</span>, id_card_number=<span class="hljs-string">&#x27;123456789&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;name&#125;</span> person is add..&quot;</span>)<br>    session.add(person)<br><br>    time.sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> name == <span class="hljs-string">&#x27;job3&#x27;</span>:<br>        <span class="hljs-comment"># 线程3 提交, 其他线程不提交.</span><br>        session.commit()<br>        session.close()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>    thread_list = []<br><br>    <span class="hljs-comment"># 创建5个线程</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        name = <span class="hljs-string">&#x27;job&#x27;</span> + <span class="hljs-built_in">str</span>(i)<br>        t = threading.Thread(target=job, name=name, args=(name,))<br><br>        thread_list.append(t)<br><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> thread_list:<br>        t.start()<br><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> thread_list:<br>        t.join()<br><br><br></code></pre></td></tr></table></figure>

<p><strong>结论：</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">每个线程下的 <span class="hljs-keyword">Session</span> 是同一个 <span class="hljs-keyword">Session</span><br>每个线程下的数据都没提交到了数据库<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br><span class="hljs-built_in">id</span> session:2810724382032<br>job0 person is add..<br><span class="hljs-built_in">id</span> session:2810724382032<br>job1 person is add..<br><span class="hljs-built_in">id</span> session:2810724382032<br>job2 person is add..<br><span class="hljs-built_in">id</span> session:2810724382032<br>job3 person is add..<br><span class="hljs-built_in">id</span> session:2810724382032<br>job4 person is add..<br><br><br>mysql&gt; select * from person;<br>+----+------------+--------+----------------+<br>| <span class="hljs-built_in">id</span> | name       | mobile | id_card_number |<br>+----+------------+--------+----------------+<br>| 33 | frank-job0 | 111111 | 123456789      |<br>| 34 | frank-job2 | 111111 | 123456789      |<br>| 35 | frank-job1 | 111111 | 123456789      |<br>| 36 | frank-job3 | 111111 | 123456789      |<br>| 37 | frank-job4 | 111111 | 123456789      |<br>+----+------------+--------+----------------+<br>5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br></code></pre></td></tr></table></figure>

<hr>
<p><strong>以上说明：</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">在同一个线程中，有 scoped_session 的时候，返回的是同一个 <span class="hljs-keyword">Session</span> 对象。<br>在多线程下，即使通过  scoped_session 创建<span class="hljs-keyword">Session</span>，每个线程下的 <span class="hljs-keyword">Session</span> 都是不一样的，每个线程都有一个属于自己的 <span class="hljs-keyword">Session</span> 对象，这个对象只在本线程下共享。 <br>scoped_session 只有在单线程下才能发挥其作用。在多线程下显得没有什么作用<br></code></pre></td></tr></table></figure>

<p> 转自：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/ChangAn223/p/11277468.html">https://www.cnblogs.com/ChangAn223/p/11277468.html</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/python%E5%8A%A0%E6%B2%B9%E9%B8%AD/" class="category-chain-item">python加油鸭</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/python-%E6%95%B0%E6%8D%AE%E5%BA%93-mysql-sql/">#python 数据库 mysql sql</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SQLAlchemy 中的 Session,sessionmaker,scoped_session详解</div>
      <div>https://waym1ng.github.io/2020/03/25/SQLAlchemy 中的 Session,sessionmaker,scoped_session详解/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>waymingz</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2020年3月25日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/03/27/Python%20%E5%90%84%E7%A7%8D%E8%BF%9B%E5%88%B6%E7%9B%B8%E4%BA%92%E8%BD%AC%E6%8D%A2%2016%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2%E6%88%902%E8%BF%9B%E5%88%B6%20%E4%B8%8D%E5%A4%9F%E7%94%A80%E8%A1%A5%E9%BD%90%20%E5%89%8D%E9%9D%A2%E8%A1%A50/" title="Python 各种进制相互转换 16进制转换成2进制 不够用0补齐 前面补0">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Python 各种进制相互转换 16进制转换成2进制 不够用0补齐 前面补0</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/03/25/python%E4%B9%8Bsqlalchemy%E8%AF%A6%E8%A7%A3/" title="python之sqlalchemy详解">
                        <span class="hidden-mobile">python之sqlalchemy详解</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"QaAc8EraW3qDuc3hldMvmw5p-gzGzoHsz","appKey":"oTgXIx2IwXcYJAPXLGPAdYJC","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      京ICP证123456号
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>京公网安备12345678号</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
